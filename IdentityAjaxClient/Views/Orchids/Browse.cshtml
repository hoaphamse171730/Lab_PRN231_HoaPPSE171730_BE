@{
    ViewData["Title"] = "Orchid Catalog";
}

<h2>@ViewData["Title"]</h2>

<div class="row mb-3">
    <div class="col-md-4">
        <input id="searchName" class="form-control" placeholder="Search by name…" />
    </div>
    <div class="col-md-3">
        <select id="filterCategory" class="form-select">
            <option value="">All categories</option>
        </select>
    </div>
    <div class="col-md-2">
        <button id="btnFilter" class="btn btn-primary">Filter</button>
    </div>
</div>

<table id="tblCatalog" class="table table-hover">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price</th>
            <th>Natural?</th>
            <th>Category</th>
            <th>Image</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const ROUTES = {
          orchids:    '@BusinessObjects.Shared.ApiRoutes.Orchids',
          categories: '@BusinessObjects.Shared.ApiRoutes.Categories'
        };

        // Use stored JWT
        const token = localStorage.getItem('jwt') || '';
        $.ajaxSetup({ headers: { 'Authorization': 'Bearer ' + token } });

        let allOrchids = [], allCategories = [];

        // Load categories into dropdown
        function loadCategories() {
          return $.get(ROUTES.categories, data => {
            allCategories = data;
            const opts = ['<option value="">All categories</option>']
              .concat(data.map(c =>
                `<option value="${c.categoryId}">${c.categoryName}</option>`));
            $('#filterCategory').html(opts.join(''));
          });
        }

        // Load orchids once
        function loadOrchids() {
          return $.get(ROUTES.orchids, data => { allOrchids = data; renderTable(data); });
        }

        // Render table given a list
        function renderTable(list) {
          const rows = list.map(o => `
            <tr>
              <td>${o.orchidId}</td>
              <td>${o.orchidName}</td>
              <td>${o.price.toFixed(2)}</td>
              <td>${o.isNatural ? 'Yes' : 'No'}</td>
              <td>${o.category?.categoryName||'—'}</td>
              <td>
                ${o.orchidUrl
                  ? `<img src="${o.orchidUrl}" style="max-height:60px;" />`
                  : '—'}
              </td>
            </tr>`).join('');
          $('#tblCatalog tbody').html(rows);
        }

        // Apply filters
        $('#btnFilter').click(() => {
          const name = $('#searchName').val().toLowerCase();
          const cat  = $('#filterCategory').val();
          const filtered = allOrchids.filter(o =>
            (!name || o.orchidName.toLowerCase().includes(name)) &&
            (!cat  || o.categoryId == cat)
          );
          renderTable(filtered);
        });

        // Init on load
        $(async function(){
          await loadCategories();
          await loadOrchids();
        });
    </script>
}
