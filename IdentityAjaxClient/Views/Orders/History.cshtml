@using BusinessObjects.Shared
@{
    ViewData["Title"] = "My Orders";
}

<h2>@ViewData["Title"]</h2>

<table id="tblHistory" class="table table-striped">
    <thead>
        <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Status</th>
            <th>Total</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<nav>
    <ul class="pagination">
        <li class="page-item" id="prevPage"><button class="page-link">Previous</button></li>
        <li class="page-item disabled"><span class="page-link" id="pageInfo"></span></li>
        <li class="page-item" id="nextPage"><button class="page-link">Next</button></li>
    </ul>
</nav>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const ROUTES   = { orders: '@BusinessObjects.Shared.ApiRoutes.Orders' };
        const token    = localStorage.getItem('jwt') || '';
        const role     = localStorage.getItem('role');
        $.ajaxSetup({ headers:{ 'Authorization':'Bearer '+token } });

        const STATUS = {
          Pending:    '@Constants.OrderStatusPending',
          Processing: '@Constants.OrderStatusProcessing',
          Completed:  '@Constants.OrderStatusCompleted',
          Cancelled:  '@Constants.OrderStatusCancelled'
        };

        const pageSize    = 10;
        let currentPage   = 1, totalCount = 0;

        function loadPage(page) {
          $.get(`${ROUTES.orders}?page=${page}&pageSize=${pageSize}`, resp => {
            const { items, totalCount: tot } = resp;
            totalCount = tot;
            renderTable(items);
            updatePagination();
          });
        }

        function renderTable(list) {
          const rows = list.map(o => {
            // Only staff get action buttons
            let btns = '';
            if (role === 'Staff') {
              if (o.orderStatus === STATUS.Pending) {
                btns = `
                  <button class="btn btn-sm btn-success process" data-id="${o.id}">Process</button>
                  <button class="btn btn-sm btn-danger cancel"  data-id="${o.id}">Cancel</button>
                `;
              } else if (o.orderStatus === STATUS.Processing) {
                btns = `
                  <button class="btn btn-sm btn-primary complete" data-id="${o.id}">Complete</button>
                  <button class="btn btn-sm btn-danger  cancel"  data-id="${o.id}">Cancel</button>
                `;
              }
            }

            return `
              <tr data-id="${o.id}">
                <td>${o.id}</td>
                <td>${new Date(o.orderDate).toLocaleString()}</td>
                <td class="status-cell">${o.orderStatus}</td>
                <td>$${o.totalAmount.toFixed(2)}</td>
                <td>
                  <a href="/Orders/Details/${o.id}" class="btn btn-sm btn-info me-1">Details</a>
                  ${btns}
                </td>
              </tr>`;
          }).join('');
          $('#tblHistory tbody').html(rows);
        }

        function updatePagination() {
          const totalPages = Math.ceil(totalCount / pageSize);
          $('#pageInfo').text(`Page ${currentPage} of ${totalPages}`);
          $('#prevPage').toggleClass('disabled', currentPage <= 1);
          $('#nextPage').toggleClass('disabled', currentPage >= totalPages);
        }

        $('#prevPage').click(()=>{ if(currentPage>1) loadPage(--currentPage); });
        $('#nextPage').click(()=>{ if(currentPage*pageSize<totalCount) loadPage(++currentPage); });

        // Shared handler for any status change
        function changeStatus(id, newStatus, $row) {
          $.ajax({
            url: `${ROUTES.orders}/${id}/status`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ status: newStatus })
          }).done(() => {
            $row.find('.status-cell').text(newStatus);
            // remove any process/complete/cancel buttons
            $row.find('.process, .complete, .cancel').remove();
          }).fail((xhr,_,err) => {
            alert('Failed to update status: ' + (xhr.responseText||err));
          });
        }

        // Button handlers
        $(document).on('click', '.process', function(){
          const id = $(this).data('id'),
                $row = $(this).closest('tr');
          changeStatus(id, STATUS.Processing, $row);
        });
        $(document).on('click', '.complete', function(){
          const id = $(this).data('id'),
                $row = $(this).closest('tr');
          changeStatus(id, STATUS.Completed, $row);
        });
        $(document).on('click', '.cancel', function(){
          const id = $(this).data('id'),
                $row = $(this).closest('tr');
          if (!confirm('Are you sure you want to cancel this order?')) return;
          changeStatus(id, STATUS.Cancelled, $row);
        });

        // Init
        $(function(){ loadPage(1); });
    </script>
}
